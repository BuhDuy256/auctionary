@startuml UC11_DanhGiaNguoiDung
' --- Cài đặt Sơ đồ ---
autonumber
actor Bidder
participant "Web Browser" as Browser
participant "Web Server\n(Controller)" as Controller
participant "Review Service\n(Business Logic)" as ReviewService
participant "Order Repository" as OrderRepo
participant "Review Repository" as ReviewRepo
participant "User Repository" as UserRepo
database "Database" as DB

' --- Luồng chính: Bidder đánh giá Seller ---

Bidder -> Browser : Truy cập "Giao dịch đã thắng", chọn "Đánh giá"
Browser -> Controller : (GET /orders/{id}/review)
Controller -> Browser : Hiển thị form đánh giá (chọn +1/-1, bình luận)

Bidder -> Browser : Điền form (chọn +1, bình luận), nhấn "Gửi"
Browser -> Controller : Gửi yêu cầu (POST /orders/{id}/review)

activate Controller
Controller -> ReviewService : submitReview(bidderId, orderId, reviewData)
activate ReviewService

' 1. Lấy thông tin Giao dịch (Order)
ReviewService -> OrderRepo : findById(orderId)
activate OrderRepo
OrderRepo -> DB : SELECT * FROM Orders WHERE id = :orderId
activate DB
DB --> OrderRepo : Trả về Order (status, bidderId, sellerId)
deactivate DB
deactivate OrderRepo

' 2. Kiểm tra logic nghiệp vụ
ReviewService -> ReviewService : Kiểm tra: Order.status == 'completed'?
ReviewService -> ReviewService : Kiểm tra: Order.bidderId == bidderId?
ReviewService -> ReviewRepo : exists(orderId, bidderId, sellerId)?
activate ReviewRepo
ReviewRepo -> DB : SELECT 1 FROM Reviews WHERE orderId = :orderId AND reviewerId = :bidderId
activate DB
DB --> ReviewRepo : (null - Chưa tồn tại)
deactivate DB
deactivate ReviewRepo

alt Logic hợp lệ (Đúng giao dịch, chưa đánh giá)
    ' 3. Lưu đánh giá
    ReviewService -> ReviewRepo : save(bidderId, sellerId, orderId, reviewData)
    activate ReviewRepo
    ReviewRepo -> DB : INSERT INTO Reviews (orderId, reviewerId, revieweeId, rating, comment) VALUES (...)
    activate DB
    DB --> ReviewRepo : OK
    deactivate DB
    deactivate ReviewRepo

    ' 4. Cập nhật điểm đánh giá (reputation) cho Seller
    ReviewService -> UserRepo : updateUserReputation(sellerId, reviewData.rating)
    activate UserRepo
    UserRepo -> DB : UPDATE Users SET reputation = reputation + :rating WHERE id = :sellerId
    activate DB
    DB --> UserRepo : OK
    deactivate DB
    deactivate UserRepo

    ' 5. Phản hồi thành công
    ReviewService --> Controller : Trả về "Đánh giá thành công"
    Controller -> Browser : Phản hồi (HTTP 200) / Tải lại trang

else Logic không hợp lệ
    ' 5b. Phản hồi lỗi
    ReviewService --> Controller : Trả về Lỗi (Error: "Không thể đánh giá" hoặc "Đã đánh giá")
    Controller -> Browser : Hiển thị thông báo lỗi
end

deactivate ReviewService
deactivate Controller

@enduml
