@startuml UC04_XemChiTietSanPham
' --- Cài đặt Sơ đồ ---
autonumber
actor Guest
participant "Web Browser" as Browser
participant "Web Server\n(Controller)" as Controller
participant "Product Service\n(Business Logic)" as ProductService
participant "Product Repository" as ProductRepo
participant "User Repository" as UserRepo
participant "Bid Repository" as BidRepo
database "Database" as DB

' --- Luồng chính: Xem chi tiết sản phẩm ---

Guest -> Browser : Nhấp vào một sản phẩm
Browser -> Controller : Yêu cầu chi tiết sản phẩm (GET /product/{id})

activate Controller
Controller -> ProductService : getProductDetails(productId)
activate ProductService

' 1. Lấy thông tin sản phẩm chính
ProductService -> ProductRepo : findById(productId)
activate ProductRepo
ProductRepo -> DB : SELECT * FROM Products WHERE id = :productId
activate DB
DB --> ProductRepo : Trả về dữ liệu sản phẩm (Product)
deactivate DB
deactivate ProductRepo

' 2. Lấy thông tin người bán
ProductService -> UserRepo : findById(Product.sellerId)
activate UserRepo
UserRepo -> DB : SELECT id, name, reputation FROM Users WHERE id = :sellerId
activate DB
DB --> UserRepo : Trà về dữ liệu Người bán (Seller)
deactivate DB
deactivate UserRepo

' 3. Lấy lịch sử ra giá
ProductService -> BidRepo : findByProductId(productId)
activate BidRepo
BidRepo -> DB : SELECT amount, created_at, userId FROM Bids WHERE productId = :productId ORDER BY created_at DESC
activate DB
DB --> BidRepo : Trả về danh sách lượt ra giá (Bids)
deactivate DB
deactivate BidRepo

' (Note: Lịch sử Hỏi/Đáp cũng sẽ được lấy tương tự)

ProductService --> Controller : Trả về đối tượng chi tiết sản phẩm (ProductDetailsDTO)
deactivate ProductService

Controller -> Browser : Hiển thị trang chi tiết sản phẩm (với tất cả dữ liệu)
deactivate Controller

@enduml
