@startuml UC09_QuanLyDanhMucXoa
' --- Cài đặt Sơ đồ ---
autonumber
actor Admin
participant "Web Browser" as Browser
participant "Web Server\n(Controller)" as Controller
participant "Category Service\n(Business Logic)" as CategoryService
participant "Category Repository" as CategoryRepo
participant "Product Repository" as ProductRepo
database "Database" as DB

' --- Luồng chính: Xóa Danh mục ---

Admin -> Browser : Nhấn nút "Xóa"
Browser -> Controller : Gửi yêu cầu (DELETE /admin/categories/{id})

activate Controller
Controller -> CategoryService : deleteCategory(categoryId)
activate CategoryService

' 1. Kiểm tra nghiệp vụ: Danh mục có sản phẩm nào không?
CategoryService -> ProductRepo : countProductsInCategory(categoryId)
activate ProductRepo
ProductRepo -> DB : SELECT COUNT(*) FROM Products WHERE categoryId = :categoryId
activate DB
DB --> ProductRepo : Trả về (count)
deactivate DB
deactivate ProductRepo

alt (count == 0) - Không có sản phẩm, được phép xóa
    ' 2. Thực hiện xóa
    CategoryService -> CategoryRepo : delete(categoryId)
    activate CategoryRepo
    CategoryRepo -> DB : DELETE FROM Categories WHERE id = :categoryId
    activate DB
    DB --> CategoryRepo : OK
    deactivate DB
    deactivate CategoryRepo

    CategoryService --> Controller : Trả về "Xóa thành công"
    Controller -> Browser : Phản hồi (HTTP 200) / Tải lại trang

else (count > 0) - Có sản phẩm, không được xóa
    ' 2b. Báo lỗi nghiệp vụ
    CategoryService --> Controller : Trả về Lỗi (Error: "Không thể xoá danh mục đã có sản phẩm")
    Controller -> Browser : Hiển thị thông báo lỗi
end

deactivate CategoryService
deactivate Controller

@enduml
