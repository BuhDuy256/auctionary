@startuml UC02_DangNhapGoogle
' --- Cài đặt Sơ đồ ---
autonumber
actor Guest
participant "Web Browser" as Browser
participant "Web Server\n(Controller)" as Controller
participant "Auth Service\n(Business Logic)" as AuthService
participant "User Repository\n(Data Access)" as UserRepo
participant "Google" as GoogleAuth
database "Database" as DB

' --- Luồng chính: Đăng nhập Social ---

Guest -> Browser : Nhấn "Đăng nhập với Google"
Browser -> GoogleAuth : Yêu cầu xác thực Google
GoogleAuth --> Browser : Hiển thị cửa sổ popup của Google

Guest -> GoogleAuth : Xác thực thành công (nhập pass Google...)
GoogleAuth -> Browser : Chuyển hướng về (callback) với mã "code"

Browser -> Controller : Gửi mã "code" đến server (GET /auth/google/callback)
activate Controller
Controller -> GoogleAuth : Yêu cầu thông tin User (dùng "code")
GoogleAuth --> Controller : Trả về thông tin User (email, tên, google_id)

Controller -> AuthService : loginWithGoogle(profile)
activate AuthService
AuthService -> UserRepo : findUserByEmail(profile.email)
activate UserRepo
UserRepo -> DB : SELECT * FROM Users WHERE email = :email
activate DB
DB --> UserRepo : Trả về kết quả
deactivate DB
deactivate UserRepo

alt Người dùng đã tồn tại
    AuthService -> AuthService : (Tùy chọn) Cập nhật thông tin (avatar, google_id)
    AuthService --> Controller : Trả về User
else Người dùng chưa tồn tại
    AuthService -> UserRepo : Tạo người dùng mới (email, tên, status='active')
    activate UserRepo
    UserRepo -> DB : INSERT INTO Users ...
    activate DB
    DB --> UserRepo : UserID mới
    deactivate DB
    deactivate UserRepo
    AuthService --> Controller : Trả về User mới
end

deactivate AuthService

Controller -> Controller : Tạo phiên đăng nhập (Session / JWT)
Controller -> Browser : Chuyển hướng đến trang chủ
deactivate Controller

@enduml
