@startuml UC12_HoanTatDonHang
' --- Cài đặt Sơ đồ ---
autonumber " "
actor Seller
actor Bidder
participant "Web Browser" as Browser
participant "Web Server\n(Controller)" as Controller
participant "Order Service\n(Business Logic)" as OrderService
participant "Order Repository\n(Data Access)" as OrderRepo
participant "Email Service" as EmailService
database "Database" as DB

' --- Bắt đầu luồng sau khi đấu giá kết thúc ---
... (Phiên đấu giá kết thúc, Order được tạo với status 'Pending') ...

' --- Bước 1: Seller cung cấp Hợp đồng ---
Seller -> Browser : (Bước 1) Cung cấp Hợp đồng
Browser -> Controller : Gửi yêu cầu (POST /orders/{id}/contract)

activate Controller
Controller -> OrderService : provideContract(sellerId, orderId)
activate OrderService
OrderService -> OrderRepo : findById(orderId)
activate OrderRepo
OrderRepo -> DB : SELECT * FROM Orders WHERE id = :orderId
activate DB
DB --> OrderRepo : (Order data, status='Pending')
deactivate DB
deactivate OrderRepo
OrderService -> OrderService : Kiểm tra (sellerId == Order.sellerId)

OrderService -> OrderRepo : updateStatus(orderId, 'Contract_Provided')
activate OrderRepo
OrderRepo -> DB : UPDATE Orders SET status = 'Contract_Provided' WHERE id = :orderId
activate DB
DB --> OrderRepo : OK
deactivate DB
deactivate OrderRepo

OrderService -> EmailService : notifyBidder(orderId, "Seller đã cung cấp HĐ")
activate EmailService
EmailService --> OrderService : (async)
deactivate EmailService
OrderService --> Controller : OK
deactivate OrderService
Controller -> Browser : Phản hồi "Cập nhật thành công"
deactivate Controller

' --- Bước 2: Bidder xác nhận Thanh toán ---
Bidder -> Browser : (Bước 2) Xác nhận đã thanh toán
Browser -> Controller : Gửi yêu cầu (POST /orders/{id}/pay)

activate Controller
Controller -> OrderService : confirmPayment(bidderId, orderId)
activate OrderService
OrderService -> OrderRepo : findById(orderId)
activate OrderRepo
OrderRepo -> DB : SELECT * FROM Orders WHERE id = :orderId
activate DB
DB --> OrderRepo : (Order data, status='Contract_Provided')
deactivate DB
deactivate OrderRepo
OrderService -> OrderService : Kiểm tra (bidderId == Order.bidderId)

OrderService -> OrderRepo : updateStatus(orderId, 'Payment_Confirmed')
activate OrderRepo
OrderRepo -> DB : UPDATE Orders SET status = 'Payment_Confirmed' WHERE id = :orderId
activate DB
DB --> OrderRepo : OK
deactivate DB
deactivate OrderRepo

OrderService -> EmailService : notifySeller(orderId, "Bidder đã xác nhận thanh toán")
activate EmailService
EmailService --> OrderService : (async)
deactivate EmailService
OrderService --> Controller : OK
deactivate OrderService
Controller -> Browser : Phản hồi "Xác nhận thành công"
deactivate Controller

' --- Bước 3: Seller xác nhận Gửi hàng ---
Seller -> Browser : (Bước 3) Xác nhận đã gửi hàng
Browser -> Controller : Gửi yêu cầu (POST /orders/{id}/ship)

activate Controller
Controller -> OrderService : confirmShipping(sellerId, orderId)
activate OrderService
OrderService -> OrderRepo : findById(orderId)
activate OrderRepo
OrderRepo -> DB : SELECT * FROM Orders WHERE id = :orderId
activate DB
DB --> OrderRepo : (Order data, status='Payment_Confirmed')
deactivate DB
deactivate OrderRepo
OrderService -> OrderService : Kiểm tra (sellerId == Order.sellerId)

OrderService -> OrderRepo : updateStatus(orderId, 'Shipped')
activate OrderRepo
OrderRepo -> DB : UPDATE Orders SET status = 'Shipped' WHERE id = :orderId
activate DB
DB --> OrderRepo : OK
deactivate DB
deactivate OrderRepo

OrderService -> EmailService : notifyBidder(orderId, "Seller đã gửi hàng")
activate EmailService
EmailService --> OrderService : (async)
deactivate EmailService
OrderService --> Controller : OK
deactivate OrderService
Controller -> Browser : Phản hồi "Xác nhận thành công"
deactivate Controller

' --- Bước 4: Bidder xác nhận Nhận hàng ---
Bidder -> Browser : (Bước 4) Xác nhận đã nhận hàng
Browser -> Controller : Gửi yêu cầu (POST /orders/{id}/deliver)

activate Controller
Controller -> OrderService : confirmDelivery(bidderId, orderId)
activate OrderService
OrderService -> OrderRepo : findById(orderId)
activate OrderRepo
OrderRepo -> DB : SELECT * FROM Orders WHERE id = :orderId
activate DB
DB --> OrderRepo : (Order data, status='Shipped')
deactivate DB
deactivate OrderRepo
OrderService -> OrderService : Kiểm tra (bidderId == Order.bidderId)

OrderService -> OrderRepo : updateStatus(orderId, 'Completed')
activate OrderRepo
OrderRepo -> DB : UPDATE Orders SET status = 'Completed' WHERE id = :orderId
activate DB
DB --> OrderRepo : OK
deactivate DB
deactivate OrderRepo

OrderService -> OrderService : Kích hoạt UC-11 (EnableReviews(orderId))
OrderService -> EmailService : notifyBothParties("Giao dịch hoàn tất")
activate EmailService
EmailService --> OrderService : (async)
deactivate EmailService
OrderService --> Controller : OK
deactivate OrderService
Controller -> Browser : Phản hồi "Giao dịch hoàn tất!"
deactivate Controller

@enduml
