@startuml UC02_DangNhapEmail
' --- Cài đặt Sơ đồ ---
autonumber
actor Guest
participant "Web Browser" as Browser
participant "Web Server\n(Controller)" as Controller
participant "Auth Service\n(Business Logic)" as AuthService
participant "User Repository\n(Data Access)" as UserRepo
database "Database" as DB

' --- Luồng chính: Đăng nhập thành công ---

Guest -> Browser : Truy cập trang đăng nhập
Browser -> Controller : Yêu cầu hiển thị form (GET /login)
Controller -> Browser : Hiển thị form Email/Mật khẩu

Guest -> Browser : Nhập Email, Mật khẩu
Browser -> Controller : Gửi thông tin đăng nhập (POST /login)

activate Controller
Controller -> AuthService : login(email, password)
activate AuthService

AuthService -> UserRepo : findUserByEmail(email)
activate UserRepo
UserRepo -> DB : SELECT * FROM Users WHERE email = :email AND status = 'active'
activate DB
DB --> UserRepo : Trả về dữ liệu User (gồm password_hash)
deactivate DB
UserRepo --> AuthService : Trả về User
deactivate UserRepo

alt Mật khẩu hợp lệ (bcrypt.compare)
    AuthService -> AuthService : So sánh mật khẩu (bcrypt.compare)
    AuthService --> Controller : Trả về User (Đăng nhập thành công)

    Controller -> Controller : Tạo phiên đăng nhập (Session / JWT)
    Controller -> Browser : Chuyển hướng đến trang chủ
else Mật khẩu không hợp lệ
    AuthService --> Controller : Trả về lỗi (Error)
    Controller -> Browser : Hiển thị thông báo "Email hoặc mật khẩu không đúng"
end

deactivate AuthService
deactivate Controller

@enduml
