@startuml UC06_ThemVaoWatchList
' --- Cài đặt Sơ đồ ---
autonumber
actor Bidder
participant "Web Browser" as Browser
participant "Web Server\n(Controller)" as Controller
participant "Watchlist Service\n(Business Logic)" as WatchlistService
participant "Watchlist Repository\n(Data Access)" as WatchlistRepo
database "Database" as DB

' --- Luồng chính: Thêm vào Watch List thành công ---

Bidder -> Browser : Nhấn nút "Thêm vào Watch List"
Browser -> Controller : Gửi yêu cầu (POST /product/{id}/watchlist)

activate Controller
Controller -> WatchlistService : addProductToWatchlist(userId, productId)
activate WatchlistService

' 1. (Tùy chọn) Kiểm tra xem đã tồn tại chưa
WatchlistService -> WatchlistRepo : exists(userId, productId)
activate WatchlistRepo
WatchlistRepo -> DB : SELECT 1 FROM Watchlist WHERE userId = :userId AND productId = :productId
activate DB
DB --> WatchlistRepo : Kết quả (Không tìm thấy)
deactivate DB
deactivate WatchlistRepo

' 2. Thêm vào Watchlist (vì chưa tồn tại)
alt Sản phẩm chưa có trong Watchlist
    WatchlistService -> WatchlistRepo : save(userId, productId)
    activate WatchlistRepo
    WatchlistRepo -> DB : INSERT INTO Watchlist (userId, productId)
    activate DB
    DB --> WatchlistRepo :
    deactivate DB
    deactivate WatchlistRepo
    
    WatchlistService --> Controller : Trả về "Thêm thành công"
else Sản phẩm đã có
    WatchlistService --> Controller : Trả về "Đã tồn tại" (hoặc xử lý gỡ bỏ nếu là toggle)
end

deactivate WatchlistService

Controller -> Browser : Phản hồi (HTTP 200 OK)
deactivate Controller
Browser -> Browser : Cập nhật trạng thái nút (VD: "Đã thêm")

@enduml
