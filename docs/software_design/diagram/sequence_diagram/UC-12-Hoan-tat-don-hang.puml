@startuml UC-12-Hoan-tat-don-hang

title UC-12: Hoàn tất đơn hàng (4 bước)

actor "Bidder (Winner)" as Bidder
actor "Seller" as Seller
participant "Frontend\n(OrderCompletionPage)" as Frontend
participant "Backend" as Backend
participant "DB" as DB

note over Frontend
  UI Components:
  - Stepper hiển thị 4 bước
  - Form nhập thông tin thanh toán (Bước 1)
  - Form xác nhận giao hàng (Bước 2)
  - Nút xác nhận nhận hàng (Bước 3)
  - Form đánh giá (Bước 4)
  - Nút "Cancel giao dịch" (cho seller)
end note

== Bước 1: Bidder cung cấp thông tin thanh toán ==

Bidder -> Frontend: Truy cập trang hoàn tất đơn hàng

Frontend -> Backend: Lấy thông tin đơn hàng\n(productId)
activate Backend

Backend -> DB: Query order info
activate DB
DB --> Backend: Order details (status: STEP_1)
deactivate DB

Backend --> Frontend: Order info
deactivate Backend

Frontend --> Bidder: Hiển thị form bước 1

Bidder -> Frontend: Nhập hóa đơn thanh toán\nvà địa chỉ giao hàng
Bidder -> Frontend: Click "Gửi thông tin"

Frontend -> Backend: Cập nhật thông tin thanh toán\n(orderId, paymentInfo, address)
activate Backend

Backend -> DB: Lưu thông tin thanh toán
activate DB
DB --> Backend: Lưu thành công
deactivate DB

Backend -> DB: Cập nhật status: STEP_2
activate DB
DB --> Backend: Cập nhật thành công
deactivate DB

Backend -> Backend: Gửi email thông báo seller

Backend --> Frontend: Cập nhật thành công
deactivate Backend

Frontend --> Bidder: Chuyển sang bước 2 (chờ seller)

== Bước 2: Seller xác nhận và gửi hàng ==

Seller -> Frontend: Truy cập trang hoàn tất đơn hàng

Frontend -> Backend: Lấy thông tin đơn hàng
activate Backend
Backend -> DB: Query order info
activate DB
DB --> Backend: Order details + payment info
deactivate DB
Backend --> Frontend: Order info
deactivate Backend

Frontend --> Seller: Hiển thị thông tin thanh toán\nForm xác nhận giao hàng

Seller -> Frontend: Nhập mã vận đơn\n(tracking number)
Seller -> Frontend: Click "Xác nhận đã gửi hàng"

Frontend -> Backend: Cập nhật thông tin vận chuyển\n(orderId, trackingNumber)
activate Backend

Backend -> DB: Lưu thông tin vận chuyển
activate DB
DB --> Backend: Lưu thành công
deactivate DB

Backend -> DB: Cập nhật status: STEP_3
activate DB
DB --> Backend: Cập nhật thành công
deactivate DB

Backend -> Backend: Gửi email thông báo bidder

Backend --> Frontend: Cập nhật thành công
deactivate Backend

Frontend --> Seller: Chuyển sang bước 3 (chờ bidder)

== Bước 3: Bidder xác nhận nhận hàng ==

Bidder -> Frontend: Truy cập trang hoàn tất đơn hàng

Frontend -> Backend: Lấy thông tin đơn hàng
activate Backend
Backend -> DB: Query order info
activate DB
DB --> Backend: Order details + tracking info
deactivate DB
Backend --> Frontend: Order info
deactivate Backend

Frontend --> Bidder: Hiển thị mã vận đơn\nNút "Đã nhận hàng"

Bidder -> Frontend: Click "Đã nhận hàng"

Frontend -> Backend: Xác nhận nhận hàng\n(orderId)
activate Backend

Backend -> DB: Cập nhật status: STEP_4
activate DB
DB --> Backend: Cập nhật thành công
deactivate DB

Backend -> Backend: Gửi email thông báo seller & bidder

Backend --> Frontend: Cập nhật thành công
deactivate Backend

Frontend --> Bidder: Chuyển sang bước 4 (đánh giá)

== Bước 4: Đánh giá chéo ==

note over Bidder, Seller
  Bidder đánh giá Seller
  Seller đánh giá Bidder
  (Xem UC-11 để biết chi tiết)
end note

== Seller hủy giao dịch ==

Seller -> Frontend: Click "Cancel giao dịch"
Frontend --> Seller: Hiển thị dialog xác nhận

Seller -> Frontend: Xác nhận hủy

Frontend -> Backend: Hủy giao dịch\n(orderId)
activate Backend

Backend -> DB: Cập nhật status: CANCELLED
activate DB
DB --> Backend: Cập nhật thành công
deactivate DB

Backend -> DB: Tự động đánh giá -1 cho bidder
activate DB
note right of DB
  Comment: "Người thắng không thanh toán"
end note
DB --> Backend: Lưu đánh giá
deactivate DB

Backend -> Backend: Gửi email thông báo bidder

Backend --> Frontend: Hủy giao dịch thành công
deactivate Backend

Frontend --> Seller: Hiển thị thông báo\nChuyển về trang sản phẩm

@enduml
