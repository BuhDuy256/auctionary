@startuml UC-13-Chat-Don-Hang

title UC-13: Chat trong quá trình hoàn tất đơn hàng

actor "Bidder (Winner)" as Bidder
actor "Seller" as Seller
participant "Frontend\n(OrderCompletionPage)" as Frontend
participant "Backend" as Backend
participant "DB" as DB

note over Frontend
  UI Components:
  - Chat box (sidebar hoặc popup)
  - Danh sách tin nhắn
  - Input nhập tin nhắn
  - Nút "Gửi"
  - Hiển thị avatar + tên người gửi
  - Timestamp tin nhắn
end note

== Mở chat ==

alt Bidder mở chat
    Bidder -> Frontend: Truy cập trang hoàn tất đơn hàng
else Seller mở chat
    Seller -> Frontend: Truy cập trang hoàn tất đơn hàng
end

Frontend -> Backend: Lấy lịch sử chat\n(orderId)
activate Backend

Backend -> DB: Query tin nhắn theo orderId
activate DB
note right of DB
  ORDER BY timestamp ASC
end note
DB --> Backend: Danh sách tin nhắn
deactivate DB

Backend --> Frontend: Lịch sử chat
deactivate Backend

Frontend --> Bidder: Hiển thị chat box + lịch sử
Frontend --> Seller: Hiển thị chat box + lịch sử

== Bidder gửi tin nhắn ==

Bidder -> Frontend: Nhập tin nhắn
Bidder -> Frontend: Click "Gửi"

Frontend -> Backend: Gửi tin nhắn\n(orderId, message, senderId)
activate Backend

Backend -> DB: Lưu tin nhắn
activate DB
note right of DB
  - Order ID
  - Sender ID (Bidder)
  - Receiver ID (Seller)
  - Message content
  - Timestamp
  - Read status: false
end note
DB --> Backend: Lưu thành công
deactivate DB

Backend -> Backend: Gửi email thông báo Seller\n(nếu Seller offline)

Backend --> Frontend: Gửi thành công
deactivate Backend

Frontend --> Bidder: Hiển thị tin nhắn mới\n(align right)

== Seller nhận tin nhắn ==

note over Seller
  Seller có thể nhận tin nhắn:
  1. Realtime (nếu đang online)
  2. Email notification
  3. Khi refresh/mở lại trang
end note

Seller -> Frontend: Refresh/Polling lấy tin nhắn mới

Frontend -> Backend: Lấy tin nhắn mới\n(orderId, lastMessageId)
activate Backend

Backend -> DB: Query tin nhắn mới
activate DB
DB --> Backend: Tin nhắn mới (chưa đọc)
deactivate DB

Backend -> DB: Cập nhật read status
activate DB
DB --> Backend: Cập nhật thành công
deactivate DB

Backend --> Frontend: Tin nhắn mới
deactivate Backend

Frontend --> Seller: Hiển thị tin nhắn\n(align left)

== Seller gửi tin nhắn ==

Seller -> Frontend: Nhập tin nhắn
Seller -> Frontend: Click "Gửi"

Frontend -> Backend: Gửi tin nhắn\n(orderId, message, senderId)
activate Backend

Backend -> DB: Lưu tin nhắn
activate DB
note right of DB
  - Sender ID (Seller)
  - Receiver ID (Bidder)
end note
DB --> Backend: Lưu thành công
deactivate DB

Backend -> Backend: Gửi email thông báo Bidder\n(nếu Bidder offline)

Backend --> Frontend: Gửi thành công
deactivate Backend

Frontend --> Seller: Hiển thị tin nhắn mới\n(align right)

note over Bidder, Seller
  Chat hỗ trợ trao đổi trong suốt
  quá trình hoàn tất đơn hàng (4 bước)
end note

@enduml
