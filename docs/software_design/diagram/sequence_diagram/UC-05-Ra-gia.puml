@startuml UC-05-Ra-gia

title UC-05: Ra giá (Place Bid)

actor "Bidder" as Bidder
participant "Frontend\n(ProductDetailPage)" as Frontend
participant "Backend" as Backend
participant "DB" as DB

note over Frontend
  UI Components:
  - Giá hiện tại
  - Bước giá
  - Input số tiền đặt giá
  - Nút "Place Bid"
  - Modal xác nhận
end note

Bidder -> Frontend: Xem chi tiết sản phẩm
Frontend --> Bidder: Hiển thị giá hiện tại + bước giá

Bidder -> Frontend: Nhập giá đặt
Frontend -> Frontend: Validate giá\n(>= giá hiện tại + bước giá)

Bidder -> Frontend: Click "Place Bid"
Frontend --> Bidder: Hiển thị modal xác nhận

Bidder -> Frontend: Xác nhận đặt giá

Frontend -> Backend: Ra giá sản phẩm\n(productId, bidAmount)
activate Backend

Backend -> DB: Kiểm tra điểm đánh giá bidder
activate DB
DB --> Backend: Rating score (+ và -)
deactivate DB

Backend -> Backend: Tính tỷ lệ đánh giá\n(+/total)

alt Rating < 80% và không phải bidder mới
    Backend --> Frontend: Lỗi: Rating không đủ để ra giá
    deactivate Backend
    Frontend --> Bidder: Hiển thị thông báo lỗi
else Rating đủ hoặc bidder mới được seller cho phép
    Backend -> DB: Kiểm tra bidder có bị từ chối không
    activate DB
    DB --> Backend: Kết quả kiểm tra
    deactivate DB
    
    alt Bidder bị từ chối
        Backend --> Frontend: Lỗi: Bạn đã bị từ chối ra giá
        deactivate Backend
        Frontend --> Bidder: Hiển thị thông báo lỗi
    else Bidder được phép ra giá
        Backend -> DB: Kiểm tra giá hợp lệ
        activate DB
        DB --> Backend: Giá hiện tại + bước giá
        deactivate DB
        
        alt Giá không hợp lệ
            Backend --> Frontend: Lỗi: Giá không hợp lệ
            deactivate Backend
            Frontend --> Bidder: Hiển thị thông báo lỗi
        else Giá hợp lệ
            Backend -> DB: Lưu lượt ra giá mới
            activate DB
            DB --> Backend: Lưu thành công
            deactivate DB
            
            Backend -> DB: Cập nhật giá sản phẩm
            activate DB
            DB --> Backend: Cập nhật thành công
            deactivate DB
            
            Backend -> Backend: Gửi email thông báo\n- Người bán\n- Bidder hiện tại\n- Bidder bị thay thế (nếu có)
            
            Backend --> Frontend: Ra giá thành công
            deactivate Backend
            Frontend --> Bidder: Hiển thị thông báo thành công\nCập nhật giá mới
        end
    end
end

@enduml
