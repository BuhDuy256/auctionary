@startuml UC-11-Danh-gia-nguoi-dung

title UC-11: Đánh giá người dùng

actor "User\n(Bidder/Seller)" as User
participant "Frontend\n(OrderCompletionPage)" as Frontend
participant "Backend" as Backend
participant "DB" as DB

note over Frontend
  UI Components:
  - Thông tin đơn hàng đã hoàn thành
  - Nút đánh giá (+1/-1)
  - Textarea nhận xét
  - Nút "Gửi đánh giá"
  - Hiển thị đánh giá hiện tại (nếu đã đánh giá)
end note

== Xem thông tin đánh giá ==

User -> Frontend: Truy cập trang hoàn tất đơn hàng

Frontend -> Backend: Lấy thông tin đơn hàng\n(orderId)
activate Backend

Backend -> DB: Query thông tin đơn hàng
activate DB
DB --> Backend: Order info (winner, seller, status)
deactivate DB

Backend -> DB: Kiểm tra đã đánh giá chưa
activate DB
DB --> Backend: Rating info (nếu có)
deactivate DB

Backend --> Frontend: Thông tin đơn hàng + rating
deactivate Backend

Frontend --> User: Hiển thị form đánh giá

== Gửi đánh giá ==

User -> Frontend: Chọn đánh giá (+1 hoặc -1)
User -> Frontend: Nhập nhận xét
User -> Frontend: Click "Gửi đánh giá"

Frontend -> Backend: Gửi đánh giá\n(orderId, rating, comment)
activate Backend

Backend -> DB: Kiểm tra trạng thái đơn hàng
activate DB
DB --> Backend: Order status
deactivate DB

alt Đơn hàng chưa hoàn thành
    Backend --> Frontend: Lỗi: Chỉ đánh giá sau khi hoàn thành
    deactivate Backend
    Frontend --> User: Hiển thị thông báo lỗi
else Đơn hàng đã hoàn thành
    Backend -> DB: Lưu/Cập nhật đánh giá
    activate DB
    note right of DB
      - Order ID
      - From User ID
      - To User ID
      - Rating (+1 / -1)
      - Comment
      - Timestamp
    end note
    DB --> Backend: Lưu thành công
    deactivate DB
    
    Backend -> DB: Cập nhật điểm rating của người được đánh giá
    activate DB
    DB --> Backend: Cập nhật thành công
    deactivate DB
    
    Backend --> Frontend: Đánh giá thành công
    deactivate Backend
    
    Frontend --> User: Hiển thị thông báo thành công\nCập nhật UI
end

note over User
  User có thể thay đổi đánh giá
  bất kỳ lúc nào
end note

== Thay đổi đánh giá ==

User -> Frontend: Thay đổi đánh giá (+1 ↔ -1)
User -> Frontend: Cập nhật nhận xét (optional)
User -> Frontend: Click "Cập nhật đánh giá"

Frontend -> Backend: Cập nhật đánh giá\n(ratingId, newRating, newComment)
activate Backend

Backend -> DB: Cập nhật đánh giá
activate DB
DB --> Backend: Cập nhật thành công
deactivate DB

Backend -> DB: Tính lại điểm rating
activate DB
DB --> Backend: Cập nhật thành công
deactivate DB

Backend --> Frontend: Cập nhật thành công
deactivate Backend

Frontend --> User: Hiển thị thông báo thành công

@enduml
