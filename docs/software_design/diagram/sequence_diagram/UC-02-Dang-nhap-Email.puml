@startuml UC-02-Dang-nhap-Email

title UC-02: Đăng nhập - Email

actor "Người dùng" as User
participant "Frontend\n(LoginPage)" as Frontend
participant "Backend" as Backend
participant "DB" as DB

note over Frontend
  UI Components:
  - Input email
  - Input password
  - reCAPTCHA
  - Nút "Log in"
  - Link "Forgot password?"
end note

User -> Frontend: Nhập email và mật khẩu
User -> Frontend: Hoàn thành reCAPTCHA
User -> Frontend: Click "Log in"

Frontend -> Backend: Đăng nhập
activate Backend

Backend -> DB: Tìm user theo email
activate DB
DB --> Backend: Thông tin user
deactivate DB

alt User không tồn tại
    Backend --> Frontend: Lỗi: Email không tồn tại
    Frontend --> User: Hiển thị thông báo lỗi
else User tồn tại
    Backend -> Backend: Kiểm tra mật khẩu (bcrypt)
    
    alt Mật khẩu sai
        Backend --> Frontend: Lỗi: Mật khẩu không đúng
        Frontend --> User: Hiển thị thông báo lỗi
    else Mật khẩu đúng
        Backend -> DB: Kiểm tra trạng thái xác minh OTP
        activate DB
        DB --> Backend: Trạng thái verified
        deactivate DB
        
        alt Chưa xác minh OTP
            Backend -> Backend: Tạo mã OTP mới
            Backend -> Backend: Gửi email OTP
            Backend --> Frontend: Yêu cầu xác nhận OTP
            Frontend --> User: Chuyển sang trang xác nhận OTP
        else Đã xác minh
            Backend -> Backend: Tạo JWT token
            Backend --> Frontend: Đăng nhập thành công\n(accessToken)
            deactivate Backend
            Frontend -> Frontend: Lưu token vào localStorage
            Frontend --> User: Chuyển đến trang chủ
        end
    end
end

@enduml
