@startuml UC10_DuyetNangCapTaiKhoan
' --- Cài đặt Sơ đồ ---
autonumber
actor Admin
participant "Web Browser" as Browser
participant "Web Server\n(Controller)" as Controller
participant "User Service\n(Business Logic)" as UserService
participant "User Repository\n(Data Access)" as UserRepo
participant "Email Service" as EmailService
database "Database" as DB

' --- Luồng chính: Admin duyệt yêu cầu ---

Admin -> Browser : Mở trang "Yêu cầu nâng cấp"
Browser -> Controller : (GET /admin/upgrades)
Controller -> Browser : Hiển thị danh sách Bidder đang chờ

Admin -> Browser : Nhấn nút "Duyệt" (Approve)
Browser -> Controller : Gửi yêu cầu (POST /admin/upgrades/{userId}/approve)

activate Controller
Controller -> UserService : approveSellerRequest(userIdToApprove)
activate UserService

' 1. (Tùy chọn) Lấy thông tin user (để gửi email)
UserService -> UserRepo : findById(userIdToApprove)
activate UserRepo
UserRepo -> DB : SELECT email, status FROM Users WHERE id = :userIdToApprove
activate DB
DB --> UserRepo : (User data)
deactivate DB
deactivate UserRepo

alt User hợp lệ và đang chờ (status == 'pending_upgrade')
    ' 2. Cập nhật vai trò (role)
    UserService -> UserRepo : updateUserRole(userIdToApprove, 'seller')
    activate UserRepo
    ' Cập nhật cả vai trò và trạng thái
    UserRepo -> DB : UPDATE Users SET role = 'seller', status = 'active' WHERE id = :userIdToApprove
    activate DB
    DB --> UserRepo : OK
    deactivate DB
    deactivate UserRepo

    ' 3. Gửi email thông báo
    UserService -> EmailService : sendApprovalEmail(User.email)
    activate EmailService
    EmailService --> UserService : (async) OK
    deactivate EmailService

    ' 4. Phản hồi thành công
    UserService --> Controller : Trả về "Duyệt thành công"
    Controller -> Browser : Phản hồi (HTTP 200) / Tải lại danh sách

else User không hợp lệ
    ' 4b. Phản hồi lỗi
    UserService --> Controller : Trả về Lỗi (Error: "Không tìm thấy yêu cầu")
    Controller -> Browser : Hiển thị thông báo lỗi
end

deactivate UserService
deactivate Controller

@enduml
