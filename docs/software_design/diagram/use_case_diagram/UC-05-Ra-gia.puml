@startuml UC05_RaGia
' --- Cài đặt Sơ đồ ---
autonumber
actor Bidder
participant "Web Browser" as Browser
participant "Web Server\n(Controller)" as Controller
participant "Auction Service\n(Business Logic)" as AuctionService
participant "Product Repository" as ProductRepo
participant "User Repository" as UserRepo
participant "Bid Repository" as BidRepo
participant "Email Service" as EmailService
database "Database" as DB

' --- Luồng chính: Ra giá thành công ---

Bidder -> Browser : Nhập số tiền, nhấn "Ra giá"
Browser -> Controller : Gửi yêu cầu (POST /product/{id}/bid)

activate Controller
Controller -> AuctionService : placeBid(userId, productId, amount)
activate AuctionService

' 1. Lấy thông tin User (để check điểm)
AuctionService -> UserRepo : findById(userId)
activate UserRepo
UserRepo -> DB : SELECT reputation FROM Users WHERE id = :userId
activate DB
DB --> UserRepo : Trả về User (với reputation)
deactivate DB
deactivate UserRepo

' 2. Lấy thông tin Sản phẩm (để check giá, thời gian)
AuctionService -> ProductRepo : findById(productId)
activate ProductRepo
ProductRepo -> DB : SELECT * FROM Products WHERE id = :productId
activate DB
DB --> ProductRepo : Trả về Product (giá, bước giá, thời gian kết thúc)
deactivate DB
deactivate ProductRepo

' 3. Kiểm tra logic nghiệp vụ
AuctionService -> AuctionService : Kiểm tra: user.reputation > 80%?
AuctionService -> AuctionService : Kiểm tra: auction.endTime > NOW()?
AuctionService -> AuctionService : Kiểm tra: amount >= product.current_price + product.step_price?

alt Logic hợp lệ
    ' 4. Lưu lượt ra giá
    AuctionService -> BidRepo : saveBid(userId, productId, amount)
    activate BidRepo
    BidRepo -> DB : INSERT INTO Bids (userId, productId, amount)
    activate DB
    DB --> BidRepo :
    deactivate DB
    deactivate BidRepo

    ' 5. Cập nhật sản phẩm
    AuctionService -> ProductRepo : updateCurrentPrice(productId, amount, userId)
    activate ProductRepo
    ProductRepo -> DB : UPDATE Products SET current_price = :amount, highest_bidder_id = :userId
    activate DB
    DB --> ProductRepo :
    deactivate DB
    deactivate ProductRepo

    ' 6. (Tùy chọn) Tự động gia hạn
    opt Ra giá trong 5 phút cuối
        AuctionService -> ProductRepo : extendAuctionTime(productId)
        activate ProductRepo
        ProductRepo -> DB : UPDATE Products SET end_time = end_time + INTERVAL '10 minutes'
        activate DB
        DB --> ProductRepo :
        deactivate DB
        deactivate ProductRepo
    end

    ' 7. Gửi thông báo
    AuctionService -> EmailService : sendBidNotification(sellerId, previousBidderId)
    activate EmailService
    EmailService --> AuctionService : (async)
    deactivate EmailService

    ' 8. Phản hồi thành công
    AuctionService --> Controller : Trả về "Ra giá thành công"
    Controller -> Browser : Chuyển hướng / Tải lại trang chi tiết

else Logic không hợp lệ (ví dụ: giá thấp)
    ' 8b. Phản hồi lỗi
    AuctionService --> Controller : Trả về Lỗi (Error: "Giá ra giá quá thấp")
    Controller -> Browser : Hiển thị thông báo lỗi
end

deactivate AuctionService
deactivate Controller

@enduml
