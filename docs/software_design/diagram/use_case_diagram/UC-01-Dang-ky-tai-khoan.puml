@startuml UC01_DangKyTaiKhoan
' --- Cài đặt Sơ đồ ---
autonumber
actor Guest
participant "Web Browser" as Browser
participant "Web Server\n(Controller)" as Controller
participant "Auth Service\n(Business Logic)" as AuthService
participant "User Repository\n(Data Access)" as UserRepo
participant "Email Service" as EmailService
participant "OTP Service" as OtpService
database "Database" as DB

' --- Luồng chính: Đăng ký tài khoản thành công ---

Guest -> Browser : Truy cập trang đăng ký
Browser -> Controller : Yêu cầu hiển thị form đăng ký (GET /register)
Controller -> Browser : Hiển thị form đăng ký với reCaptcha

Guest -> Browser : Nhập thông tin (Email, Pass, Tên) và hoàn thành reCaptcha
Browser -> Controller : Gửi dữ liệu đăng ký (POST /register)

activate Controller
Controller -> AuthService : Validate dữ liệu và reCaptcha
activate AuthService
AuthService -> UserRepo : Kiểm tra Email tồn tại?
activate UserRepo
UserRepo -> DB : SELECT * FROM Users WHERE email = :email
activate DB
DB --> UserRepo : Kết quả (Email chưa tồn tại)
deactivate DB
deactivate UserRepo
AuthService -> AuthService : Mã hóa mật khẩu (bcrypt/scrypt)
AuthService -> UserRepo : Tạo người dùng tạm thời (User, trạng thái pending)
activate UserRepo
UserRepo -> DB : INSERT INTO Users (email, password_hash, name, status)
activate DB
DB --> UserRepo : UserID mới
deactivate DB
deactivate UserRepo
AuthService -> OtpService : Tạo mã OTP (UserID)
activate OtpService
OtpService -> DB : INSERT INTO OTPs (userID, code, expiry)
activate DB
DB --> OtpService : OTP được lưu
deactivate DB
deactivate OtpService

AuthService -> EmailService : Gửi email OTP (Email, OTP Code)
activate EmailService
EmailService --> AuthService : Email đã gửi
deactivate EmailService
deactivate AuthService

Controller -> Browser : Chuyển hướng đến trang xác thực OTP

deactivate Controller

' --- Luồng chính: Xác thực OTP ---

Guest -> Browser : Nhập mã OTP
Browser -> Controller : Gửi mã OTP (POST /verify-otp)

activate Controller
Controller -> AuthService : Xác thực OTP (UserID, OTP Code)
activate AuthService
AuthService -> OtpService : Kiểm tra OTP hợp lệ và còn hạn? (UserID, OTP Code)
activate OtpService
OtpService -> DB : SELECT * FROM OTPs WHERE userID = :userID AND code = :code AND expiry > NOW()
activate DB
DB --> OtpService : Kết quả (OTP hợp lệ)
deactivate DB
OtpService -> OtpService : Xóa/Vô hiệu hóa OTP đã dùng
OtpService -> DB : UPDATE OTPs SET status = 'used' WHERE id = :otpId
activate DB
DB --> OtpService :
deactivate DB
deactivate OtpService

AuthService -> UserRepo : Cập nhật trạng thái người dùng thành "active"
activate UserRepo
UserRepo -> DB : UPDATE Users SET status = 'active' WHERE id = :userID
activate DB
DB --> UserRepo :
deactivate DB
deactivate UserRepo

AuthService --> Controller : Xác thực thành công
deactivate AuthService

Controller -> Controller : Tạo phiên đăng nhập (session)
Controller -> Browser : Chuyển hướng đến trang chủ (Đăng nhập thành công)
deactivate Controller

@enduml
